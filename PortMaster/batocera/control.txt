#!/bin/bash

# TODO: check this
CUR_TTY=/dev/tty0

directory="userdata/roms"

ESUDO=""
ESUDOKILL="-1" # for 351Elec and EmuELEC use "-1" (numeric one) or "-k" 

if [ -f "$HOME/.config/gamecontrollerdb.txt" ]; then
  export SDL_GAMECONTROLLERCONFIG_FILE="$HOME/.config/gamecontrollerdb.txt"
# elif [ -f "/usr/share/sdl-jstest/gamecontrollerdb.txt" ]; then
#   export SDL_GAMECONTROLLERCONFIG_FILE="/usr/share/sdl-jstest/gamecontrollerdb.txt"
else
  export SDL_GAMECONTROLLERCONFIG_FILE="/$controlfolder/batocera/gamecontrollerdb.txt"
fi

SDLDBFILE="${SDL_GAMECONTROLLERCONFIG_FILE}"
SDLDBUSERFILE="${HOME}/.config/SDL-GameControllerDB/gamecontrollerdb.txt"
[ ! -f "${SDLDBUSERFILE}" ] && SDLDBUSERFILE="$SDL_GAMECONTROLLERCONFIG_FILE"

get_controls() {
  # TODO: figure out SDL_GAMECONTROLLERCONFIG
  ANALOGSTICKS="2"
  LOWRES="N"

  export SDL_GAMECONTROLLERCONFIG_FILE="/tmp/gamecontrollerdb.txt"

  # Spit the controller of the device our heuristics found (if it did).
  if [[ ! -z ${DEVICE} ]]; then
    grep "${SDLDBUSERFILE}" -e "${DEVICE}" > /tmp/gamecontrollerdb.txt
  else
    echo "" > /tmp/gamecontrollerdb.txt
  fi

  if [ -f "$controlfolder/cwtbe_flag" ]; then
    if [ -f "$HOME/configs/emulationstation/es_input.cfg" ]; then
      $controlfolder/mapper.py -i "${HOME}/configs/emulationstation/es_input.cfg" "/tmp/gamecontrollerdb.txt" > /dev/null 2>&1
    fi
  fi

  sdl_controllerconfig="$(< "${SDL_GAMECONTROLLERCONFIG_FILE}")"
}

if [ -e "/lib/ld-linux-x86-64.so.2" ]; then
  # CRUSH KILL DESTROY
  if [ -f "$controlfolder/gptokeyb.x86_64" ]; then
    mv "$controlfolder/gptokeyb.x86_64" "$controlfolder/gptokeyb"
  fi

  if [ -f "$controlfolder/gptokeyb2.x86_64" ]; then
    mv "$controlfolder/gptokeyb2.x86_64" "$controlfolder/gptokeyb2"
  fi

  if [ -f "$controlfolder/xdelta3.x86_64" ]; then
    mv "$controlfolder/xdelta3.x86_64" "$controlfolder/xdelta3"
  fi

  if [ -f "$controlfolder/xmlstarlet.x86_64" ]; then
    mv "$controlfolder/xmlstarlet.x86_64" "$controlfolder/xmlstarlet"
  fi
fi

source $controlfolder/device_info.txt
source $controlfolder/funcs.txt

GPTOKEYB2="$ESUDO env LD_PRELOAD=$controlfolder/libinterpose.${DEVICE_ARCH}.so $controlfolder/gptokeyb2 $ESUDOKILL"
GPTOKEYB="$ESUDO $controlfolder/gptokeyb $ESUDOKILL"
