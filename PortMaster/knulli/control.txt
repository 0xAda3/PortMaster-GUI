#!/bin/bash

# TODO: check this
CUR_TTY=/dev/tty0

directory="userdata/roms"

ESUDO=""
ESUDOKILL="-1" # for 351Elec and EmuELEC use "-1" (numeric one) or "-k" 
if [[ -f "${HOME}/.config/gamecontrollerdb.txt" ]]; then
  export SDL_GAMECONTROLLERCONFIG_FILE="$HOME/.config/gamecontrollerdb.txt"
else
  export SDL_GAMECONTROLLERCONFIG_FILE="/$controlfolder/knulli/gamecontrollerdb.txt"
fi

SDLDBFILE="${SDL_GAMECONTROLLERCONFIG_FILE}"
SDLDBUSERFILE="${HOME}/.config/SDL-GameControllerDB/gamecontrollerdb.txt"
[[ ! -f "${SDLDBUSERFILE}" ]] && SDLDBUSERFILE="$SDL_GAMECONTROLLERCONFIG_FILE"

get_controls() {
  # TODO: figure out SDL_GAMECONTROLLERCONFIG
  ANALOGSTICKS="2"
  LOWRES="N"

  RGDEFAULT="Deeplay-keys"
  RG40XX_H="Anbernic RG40XX-H Controller"
  RG40XX_V="Anbernic RG40XX-V Controller"
  RG35XX_Plus="Anbernic RG35XX-Plus Controller"
  RG35XX_SP="Anbernic RG35XX-SP Controller"
  RG35XX_H="Anbernic RG35XX-H Controller"
  RGCUBEXX="Anbernic RG CubeXX Controller"
  RG28XX="Anbernic RG28XX Controller"

  export SDL_GAMECONTROLLERCONFIG_FILE="/tmp/gamecontrollerdb.txt"

  # Spit the controller of the device our heuristics found (if it did).
  grep "${SDLDBUSERFILE}" -E "(${RGDEFAULT}|${RG40XX_H}|${RG40XX_V}|${RG35XX_Plus}|${RG35XX_SP}|${RG35XX_H}|${RGCUBEXX}|${RG28XX})" > "${SDL_GAMECONTROLLERCONFIG_FILE}"
  if [[ ! $? -eq 0 ]]; then
    # Start with an empty file
    echo "" > "${SDL_GAMECONTROLLERCONFIG_FILE}"
  fi

  # If there is a user es_input.cfg
  if [[ -f "${HOME}/configs/emulationstation/es_input.cfg" ]]; then
    $controlfolder/mapper.py -i "${HOME}/configs/emulationstation/es_input.cfg" "/tmp/gamecontrollerdb.txt" > /dev/null 2>&1
  # Fallback to the default es_input.cfg
  elif [[ -f "/usr/share/emulationstation/es_input.cfg" ]]; then
    $controlfolder/mapper.py -i "/usr/share/emulationstation/es_input.cfg" "/tmp/gamecontrollerdb.txt" > /dev/null 2>&1
  fi

  sdl_controllerconfig="$(< "${SDL_GAMECONTROLLERCONFIG_FILE}")"
}

source $controlfolder/device_info.txt
source $controlfolder/funcs.txt

GPTOKEYB2="$ESUDO env LD_PRELOAD=$controlfolder/libinterpose.${DEVICE_ARCH}.so $controlfolder/gptokeyb2 $ESUDOKILL"
GPTOKEYB="$ESUDO $controlfolder/gptokeyb $ESUDOKILL"
